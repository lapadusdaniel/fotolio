import { useState, useEffect, useRef } from 'react'
import slugify from 'slugify'
import Masonry from 'react-masonry-css'
import { auth, db } from '../firebase'
import { collection, addDoc, deleteDoc, doc, query, where, onSnapshot, updateDoc } from 'firebase/firestore'
import { uploadPoza, listPoze, getPozaUrl, deletePoza } from '../r2'
import Lightbox from './Lightbox'
import './Dashboard.css'

function Dashboard({ user, onLogout }) {
  const [galerii, setGalerii] = useState([])
  const [showAddGalerie, setShowAddGalerie] = useState(false)
  const [numeGalerie, setNumeGalerie] = useState('')
  const [dataEveniment, setDataEveniment] = useState('')
  const [dataExpirare, setDataExpirare] = useState('')
  const [loading, setLoading] = useState(true)
  const [galerieActiva, setGalerieActiva] = useState(null)
  const [pozeGalerie, setPozeGalerie] = useState([])
  const [uploading, setUploading] = useState(false)
  const [uploadProgress, setUploadProgress] = useState(0)
  const [filtruAdmin, setFiltruAdmin] = useState('toate')
  const fileInputRef = useRef(null)
  const [indexPozaSelectata, setIndexPozaSelectata] = useState(null)
  const [activeMenu, setActiveMenu] = useState('drive')

  const masonryBreakpoints = { default: 4, 1200: 3, 800: 2, 500: 1 }

  // 1. Efect pentru preluarea galeriilor din Firebase
  useEffect(() => {
    if (!user?.uid) return
    const q = query(collection(db, 'galerii'), where('userId', '==', user.uid))
    const unsubscribe = onSnapshot(q, (snapshot) => {
      setGalerii(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })))
      setLoading(false)
    })
    return () => unsubscribe()
  }, [user?.uid])

  // 2. Efect pentru persisten»õƒÉ la refresh (Aici e Pasul A)
  useEffect(() => {
    const savedGalId = localStorage.getItem('last_gal_id');
    if (savedGalId && galerii.length > 0 && !galerieActiva) {
      const gal = galerii.find(g => g.id === savedGalId);
      if (gal) handleDeschideGalerie(gal);
    }
  }, [galerii]);

  const handleAddGalerie = async (e) => {
    e.preventDefault()
    if (!numeGalerie) return
    try {
      const slug = `${slugify(numeGalerie, { lower: true })}-${Date.now()}`
      await addDoc(collection(db, 'galerii'), {
        nume: numeGalerie,
        slug: slug,
        userId: user.uid,
        userName: user.displayName || 'Daniel Lapadus',
        dataEveniment: dataEveniment || new Date().toISOString().split('T')[0],
        dataExpirare: dataExpirare || '',
        statusActiv: true,
        favorite: [],
        coverUrl: '',
        poze: 0
      })
      setShowAddGalerie(false)
      setNumeGalerie('')
      setDataEveniment('')
      setDataExpirare('')
    } catch (error) {
      alert('Eroare la creare!')
    }
  }

  const handleDeschideGalerie = async (galerie) => {
    setGalerieActiva(galerie)
    localStorage.setItem('last_gal_id', galerie.id) // Aici e Pasul B (salvƒÉm ID-ul)
    
    try {
      const poze = await listPoze(galerie.id, user.uid)
      const pozeWithUrls = await Promise.all(poze.map(async (p) => ({
        key: p.key || p.Key,
        url: await getPozaUrl(p.key || p.Key)
      })))
      setPozeGalerie(pozeWithUrls.filter(p => p.key))
    } catch (e) {
      console.error(e)
    }
  }

  const handleSetCover = async (p) => {
    try {
      await updateDoc(doc(db, 'galerii', galerieActiva.id), { coverUrl: p.url })
      alert('CopertƒÉ setatƒÉ!')
    } catch (e) {
      alert('Eroare!')
    }
  }

  const handleUploadPoze = async (e) => {
    const files = Array.from(e.target.files)
    if (!files.length || !galerieActiva) return
    setUploading(true)
    try {
      for (let i = 0; i < files.length; i++) {
        await uploadPoza(files[i], galerieActiva.id, user.uid, (p) => 
          setUploadProgress(Math.round(((i + p/100) / files.length) * 100))
        )
      }
      await updateDoc(doc(db, 'galerii', galerieActiva.id), { poze: (galerieActiva.poze || 0) + files.length })
      handleDeschideGalerie(galerieActiva)
    } catch (error) {
      console.error(error)
    } finally {
      setUploading(false)
      setUploadProgress(0)
    }
  }

  const handleStergePoza = async () => {
    if (indexPozaSelectata === null) return
    const pozaCurenta = pozeGalerie[indexPozaSelectata]
    if (window.confirm('»òtergi poza?')) {
      try {
        await deletePoza(pozaCurenta.key)
        const noiPoze = pozeGalerie.filter((_, i) => i !== indexPozaSelectata)
        setPozeGalerie(noiPoze)
        await updateDoc(doc(db, 'galerii', galerieActiva.id), { poze: noiPoze.length })
        if (noiPoze.length === 0) setIndexPozaSelectata(null)
        else if (indexPozaSelectata >= noiPoze.length) setIndexPozaSelectata(noiPoze.length - 1)
      } catch (e) {
        console.error(e)
      }
    }
  }

  // VIEW: Galerie deschisƒÉ
  if (galerieActiva) {
    const pozeDeAfisat = filtruAdmin === 'favorite' 
      ? pozeGalerie.filter(p => galerieActiva.favorite?.includes(p.key))
      : pozeGalerie

    return (
      <div className="gallery-view">
        <header className="gallery-header">
          <div className="gallery-header-left">
            {/* Aici e Pasul C (»ôtergem ID-ul c√¢nd ne √Æntoarcem la Dashboard) */}
            <button className="btn-back" onClick={() => {
              setGalerieActiva(null);
              localStorage.removeItem('last_gal_id');
            }}>
              ‚Üê Dashboard
            </button>
            <h2>{galerieActiva.nume}</h2>
          </div>
          <div className="gallery-header-right">
            <div className="filter-buttons">
              <button 
                className={`filter-btn ${filtruAdmin === 'toate' ? 'active-filter' : ''}`}
                onClick={() => setFiltruAdmin('toate')}
              >
                Toate
              </button>
              <button 
                className={`filter-btn favorites ${filtruAdmin === 'favorite' ? 'active-filter' : ''}`}
                onClick={() => setFiltruAdmin('favorite')}
              >
                Favorite ({galerieActiva.favorite?.length || 0})
              </button>
            </div>
            <button className="btn-upload" onClick={() => fileInputRef.current.click()}>
              {uploading ? `Upload ${uploadProgress}%` : '+ AdaugƒÉ Poze'}
            </button>
            <input ref={fileInputRef} type="file" multiple hidden onChange={handleUploadPoze} />
          </div>
        </header>

        <div className="gallery-photos">
          <Masonry 
            breakpointCols={masonryBreakpoints} 
            className="my-masonry-grid" 
            columnClassName="my-masonry-grid_column"
          >
            {pozeDeAfisat.map((p, index) => {
              const isFav = galerieActiva.favorite?.includes(p.key)
              return (
                <div 
                  key={p.key} 
                  className={`photo-card ${isFav ? 'favorite' : ''}`}
                  onClick={() => setIndexPozaSelectata(index)}
                >
                  <img src={p.url} alt="Gallery" />
                  <div className="photo-overlay">
                    <button 
                      className="btn-overlay"
                      onClick={(e) => { e.stopPropagation(); handleSetCover(p) }}
                    >
                      ‚≠ê CopertƒÉ
                    </button>
                  </div>
                </div>
              )
            })}
          </Masonry>
        </div>

        {indexPozaSelectata !== null && (
          <div style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh', zIndex: 9999 }}>
            <Lightbox 
              photos={pozeDeAfisat}
              currentIndex={indexPozaSelectata}
              onClose={() => setIndexPozaSelectata(null)}
              onNext={() => setIndexPozaSelectata((prev) => (prev + 1) % pozeDeAfisat.length)}
              onPrev={() => setIndexPozaSelectata((prev) => (prev - 1 + pozeDeAfisat.length) % pozeDeAfisat.length)}
              onDelete={handleStergePoza}
            />
          </div>
        )}
      </div>
    )
  }

  // VIEW: Dashboard principal cu SIDEBAR
  return (
    <div className="dashboard-layout">
      {/* SIDEBAR */}
      <aside className="dashboard-sidebar">
        <h1>üì∏ FOTOLIO</h1>
        
        <button 
          className={`sidebar-button ${activeMenu === 'drive' ? 'active' : ''}`}
          onClick={() => setActiveMenu('drive')}
        >
          üíæ Drive
        </button>
        
        <button 
          className={`sidebar-button ${activeMenu === 'previews' ? 'active' : ''}`}
          onClick={() => setActiveMenu('previews')}
        >
          üëÅÔ∏è Previews
        </button>
        
        <button 
          className={`sidebar-button ${activeMenu === 'reviews' ? 'active' : ''}`}
          onClick={() => setActiveMenu('reviews')}
        >
          ‚≠ê Reviews
        </button>
        
        <button 
          className={`sidebar-button ${activeMenu === 'analytics' ? 'active' : ''}`}
          onClick={() => setActiveMenu('analytics')}
        >
          üìä Analytics
        </button>
        
        <button 
          className={`sidebar-button ${activeMenu === 'settings' ? 'active' : ''}`}
          onClick={() => setActiveMenu('settings')}
        >
          ‚öôÔ∏è Settings
        </button>
        
        <button className="sidebar-button logout" onClick={onLogout}>
          Ie»ôire
        </button>
      </aside>

      {/* MAIN CONTENT */}
      <div className="dashboard-main">
        <header className="dashboard-header">
          <h1>
            {activeMenu === 'drive' && 'üíæ DRIVE'}
            {activeMenu === 'previews' && 'üëÅÔ∏è PREVIEWS'}
            {activeMenu === 'reviews' && '‚≠ê REVIEWS'}
            {activeMenu === 'analytics' && 'üìä ANALYTICS'}
            {activeMenu === 'settings' && '‚öôÔ∏è SETTINGS'}
          </h1>
          <span className="user-info">{user.name || user.email}</span>
        </header>

        {/* VIEW DRIVE */}
        {activeMenu === 'drive' && (
          <div className="drive-content">
            <div className="drive-header">
              <h2>GALERIILE TALE</h2>
              <button className="btn-add-gallery" onClick={() => setShowAddGalerie(!showAddGalerie)}>
                {showAddGalerie ? 'ANULEAZƒÇ' : '+ GALERIE NOUƒÇ'}
              </button>
            </div>

            {showAddGalerie && (
              <form className="add-gallery-form" onSubmit={handleAddGalerie}>
                <div className="form-field">
                  <label>Nume Galerie</label>
                  <input type="text" value={numeGalerie} onChange={e => setNumeGalerie(e.target.value)} required />
                </div>
                <div className="form-field">
                  <label>Data Eveniment</label>
                  <input type="date" value={dataEveniment} onChange={e => setDataEveniment(e.target.value)} />
                </div>
                <div className="form-field">
                  <label>Data Expirare</label>
                  <input type="date" value={dataExpirare} onChange={e => setDataExpirare(e.target.value)} />
                </div>
                <button type="submit" className="btn-create">CREEAZƒÇ</button>
              </form>
            )}

            <div className="gallery-grid">
              {galerii.map((g) => (
                <div key={g.id} className={`gallery-card ${!g.statusActiv ? 'inactive' : ''}`}>
                  <div 
                    className="gallery-cover"
                    style={{ 
                      backgroundImage: g.coverUrl ? `url(${g.coverUrl})` : 'none'
                    }}
                  >
                    <div className={`gallery-status ${g.statusActiv ? 'active' : 'inactive'}`}>
                      {g.statusActiv ? 'ACTIV' : 'DEZACTIVAT'}
                    </div>
                    <div className="gallery-cover-info">
                      <h3>{g.nume}</h3>
                      <small>üìÖ {g.dataEveniment}</small>
                    </div>
                  </div>
                  <div className="gallery-info">
                    <div className="gallery-stats">
                      <span>üì∏ <strong>{g.poze || 0}</strong> poze</span>
                      <span>‚ù§Ô∏è <strong>{g.favorite?.length || 0}</strong> selec»õii</span>
                      <span className={`stat-expiry ${g.dataExpirare ? 'has-expiry' : ''}`}>
                        ‚è≥ {g.dataExpirare || 'Permanent'}
                      </span>
                    </div>
                    <div className="gallery-actions">
                      <button className="btn-manage" onClick={() => handleDeschideGalerie(g)}>
                        GESTIONEAZƒÇ
                      </button>
                      <button 
                        className="btn-toggle"
                        onClick={() => updateDoc(doc(db, 'galerii', g.id), { statusActiv: !g.statusActiv })}
                      >
                        {g.statusActiv ? 'DEZACTIVEAZƒÇ' : 'ACTIVEAZƒÇ'}
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* PLACEHOLDER VIEWS */}
        {activeMenu === 'previews' && (
          <div className="placeholder-view">
            <h2>üëÅÔ∏è</h2>
            <h3>Previews</h3>
            <p>Feature √Æn dezvoltare...</p>
          </div>
        )}

        {activeMenu === 'reviews' && (
          <div className="placeholder-view">
            <h2>‚≠ê</h2>
            <h3>Reviews</h3>
            <p>Feature √Æn dezvoltare...</p>
          </div>
        )}

        {activeMenu === 'analytics' && (
          <div className="placeholder-view">
            <h2>üìä</h2>
            <h3>Analytics</h3>
            <p>Feature √Æn dezvoltare...</p>
          </div>
        )}

        {activeMenu === 'settings' && (
          <div className="placeholder-view">
            <h2>‚öôÔ∏è</h2>
            <h3>Settings</h3>
            <p>Feature √Æn dezvoltare...</p>
          </div>
        )}
      </div>
    </div>
  )
}

export default Dashboard